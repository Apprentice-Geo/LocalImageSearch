# LocalImageSearch

本项目实现了一个本地图片检索（Content-Based Image Retrieval, CBIR）的小型框架。它通过多种图像特征（PCA、HOG、ResNet-50）对图片进行特征提取，并支持基于欧式距离或余弦相似度的检索。项目包含一个简单的图形界面（基于 tkinter + ttkbootstrap）用于选择查询图像并展示检索结果。

## 关键特性

- 多种特征提取：PCA（灰度图 PCA）、HOG、ResNet-50（预训练特征）
- 相似度度量：欧式距离（Euler）与余弦相似度（Cosine）
- 简单的 GUI（`UI.py`）用于选择查询图像并查看检索结果
- 能保存与重用每张图片的特征数据（保存在 `picDatas/` 中）以加速后续检索

## 项目结构

- `dataSet.py` - 特征提取与数据集读取/保存逻辑（包含 `feature`, `pic`, `dataSet` 类）
- `search.py` - 检索核心实现（`SearchCore`），执行特征比对并返回排序结果
- `UI.py` - 基于 `ttkbootstrap` 的图形界面，调用 `SearchCore` 完成交互式检索
- `requirements.txt` - Python 依赖列表
- `resource/` - 资源目录（示例图片、占位图等）
- `pics/` - 存放待索引的图片（项目运行前需准备或放入图片）
- `picDatas/` - 存放为每张图片生成的特征 numpy 文件（由 `dataSet.py` 或第一次运行时自动生成）
- `searchPics/` - 临时保存用户选中的查询图像缩放版本（由 GUI 使用）

> 注意：上述 `pics/`、`picDatas/`、`searchPics/` 目录应在运行前存在，或在首次运行时由用户创建。

## 依赖

项目依赖见 `requirements.txt`（附件），主要有：

- numpy
- opencv-python
- Pillow
- scikit-learn
- torch / torchvision
- ttkbootstrap

在带有 CUDA 的环境下，`requirements.txt` 中指定了带 CUDA 的 torch 版本。若你的环境无 CUDA，请安装对应的 CPU-only 版本或适配合适的 torch 轮子。

安装依赖（示例）：

```powershell
python -m pip install -r requirements.txt
```

（Windows PowerShell）

## 快速上手

1. 准备目录与图片
   - 在项目根目录下创建 `pics/`，把待索引的图片放到 `pics/` 中
   - 创建 `picDatas/` 和 `searchPics/` 目录用于保存特征与临时查询图
   - 确保 `resource/` 目录下包含 GUI 需要的占位图（项目已包含 `resource/Noresult.png`）

2. 生成或加载特征数据
   - 直接运行 `dataSet.py`：

   ```powershell
   python dataSet.py
   ```

   该脚本会读取 `pics/` 中的图片，并在 `picDatas/` 中查找对应的特征文件（以 `PCA_`、`HOG_`、`Resnet50_` 开头）。若某些特征文件缺失，会自动计算并保存。

3. 使用图形界面进行检索

   ```powershell
   python UI.py
   ```

   - 点击 "Choose an image" 选择一张本地图片作为查询图像。GUI 会保存一个缩放版本到 `searchPics/`。
   - 在 "Search options" 中选择特征和相似度度量，然后点击 "Search"。


## 注意事项与提示

- 图片尺寸：项目在 `pic` 类中会统一将读入图片调整为 `1600x900`，这可以保证 HOG、PCA 的输入尺寸一致。
- ResNet-50 特征采集使用 torchvision 的预训练模型（fc 层被替换为 Identity），如需在 CPU 上运行，请使用对应的 torch 版本或在 `feature.initResnet50` 中将模型和张量移动到合适设备（当前实现未显式设置 device）。
- PCA 实现：`getPCA` 中目前是直接对传入对象的灰度图做 PCA，维度在 `feature.__init__` 中被设为 500（可能需要根据数据量调整）。
- 当数据集较大或使用 ResNet 提取特征时，首次计算会较慢，建议先批量生成 `picDatas/` 中的特征文件以加速后续检索。

## 许可证

本仓库使用 MIT 许可证，详见 `LICENSE` 文件。

## English

This repository implements a small local image retrieval (Content-Based Image Retrieval, CBIR) framework. It extracts image features using multiple methods (PCA, HOG, ResNet-50) and supports retrieval based on Euclidean distance or cosine similarity. A simple GUI (tkinter + ttkbootstrap) is included for selecting a query image and displaying search results.

Key features

- Multiple feature extractors: PCA (grayscale PCA), HOG, ResNet-50 (pretrained)
- Similarity measures: Euclidean (Euler) and Cosine
- Simple GUI (`UI.py`) for choosing a query image and viewing results
- Per-image feature files are saved in `picDatas/` to speed up subsequent searches

Project structure

- `dataSet.py` - feature extraction and dataset load/save logic (classes: `feature`, `pic`, `dataSet`)
- `search.py` - search core (`SearchCore`) that compares features and returns ranked results
- `UI.py` - GUI built with `ttkbootstrap`, which calls `SearchCore` for interactive searching
- `requirements.txt` - Python dependency list
- `resource/` - resources (example images, placeholder images)
- `pics/` - place images to be indexed (create/populate before running)
- `picDatas/` - stores per-image numpy feature files (generated by `dataSet.py` on first run)
- `searchPics/` - temporarily stores scaled copies of user-selected query images (used by GUI)

Dependencies

See `requirements.txt`. Main dependencies include numpy, opencv-python (OpenCV), Pillow, scikit-learn, torch/torchvision, and ttkbootstrap. The provided `requirements.txt` pins a CUDA-enabled torch build; if your environment has no CUDA, install an appropriate CPU-only torch build instead.

Install dependencies (PowerShell example):

```powershell
python -m pip install -r requirements.txt
```

Quick start

1. Prepare folders and images
   - Create `pics/` in the project root and put images to index there
   - Create `picDatas/` and `searchPics/` to store features and temporary query images
   - Ensure `resource/` contains the GUI placeholder image (e.g. `resource/Noresult.png`)

2. Generate or load features
   - Run `dataSet.py`:

   ```powershell
   python dataSet.py
   ```

   The script reads images in `pics/` and looks for feature files in `picDatas/` named with prefixes `PCA_`, `HOG_`, or `Resnet50_`. Missing features will be computed and saved.

3. Use the GUI to search

```powershell
python UI.py
```

- Click "Choose an image" to select a local image. The GUI saves a scaled copy to `searchPics/`.
- Choose feature and similarity options in "Search options", then click "Search".

Command-line example

```powershell
python search.py
```

Notes and tips

- Images are resized to 1600x900 in the `pic` class to ensure consistent inputs for HOG and PCA.
- PCA target components are set to 500 in `feature.__init__` (adjust if needed for your dataset).
- ResNet-50 feature extraction uses a pretrained torchvision model with the final fc replaced by Identity; the implementation does not explicitly set the device—adjust model/tensor device placement for CPU/GPU environments if necessary.
- First-time ResNet feature extraction can be slow on large datasets—consider batch processing and saving `picDatas/` beforehand.

License

This repository is licensed under the MIT License. See the `LICENSE` file for details.

